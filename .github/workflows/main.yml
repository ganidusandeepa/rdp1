name: CI

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest  # Kali Linux is based on Ubuntu, so using ubuntu-latest

    steps:
    - name: Download and install the latest Ngrok
      run: |
        # Fetch the latest version of Ngrok from the official release URL
        wget https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip -O ngrok.zip
        unzip ngrok.zip
        sudo mv ngrok /usr/local/bin/ngrok  # Move it to a directory in the PATH

    - name: Authenticate Ngrok
      run: ./ngrok authtoken $NGROK_AUTH_TOKEN
      env:
        NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}

    - name: Install and Enable RDP (xrdp)
      run: |
        sudo apt update
        sudo apt install -y xrdp
        sudo systemctl enable xrdp
        sudo systemctl start xrdp

    - name: Check existing users
      run: |
        echo "Existing users:"
        cut -d: -f1 /etc/passwd  # List all users on the system

    - name: Remove password for user runneradmin (Passwordless Login)
      run: |
        if id "runneradmin" &>/dev/null; then
          sudo passwd -d runneradmin  # Remove the password for the runneradmin user
        else
          echo "User 'runneradmin' not found. Please check the user name."
        fi

    - name: Set up auto-login for xrdp
      run: |
        # Create a default X session for the user (to be run when RDP starts)
        echo "startxfce4" > ~/.xsession
        # Modify xrdp to not require a password for login
        sudo sed -i 's/param=/param=console/' /etc/xrdp/xrdp.ini

    - name: Create Tunnel
      run: ./ngrok tcp 3389  # Create an Ngrok tunnel for RDP on port 3389
